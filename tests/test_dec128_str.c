/* tests/test_dec128_str.c - Unit tests for dec128_set_str and dec128_get_str */

#include <stdio.h>
#include <string.h>
#include "dec128.h"

int main(void) {
    dec128_t x;
    char buf[128];

    // List of test cases: input string and expected output string
    struct {
        const char *input;
        const char *expected;
    } tests[] = {
        {"123456789012345678901234567890", "123456789012345678901234567890"},
        {"123456789012345678901234567890.123456789012345678901234567890",
         "123456789012345678901234567890.1235"},
        {"0.0000000000000000000000000000123456789012345678901234567890",
         "1.2345678901234567890123456789e-29"},
        {"1e100", "1e100"},
        {"1e-100", "1e-100"},
        { "123.45", "123.45" },
        { "-0.123", "-0.123" },
        { "-0.0123", "-0.0123" },
        { "-0.00123", "-0.00123" },
        { "-0.000123", "-0.000123" },
        { "-0.0000123", "-0.0000123" },
        { "-0.00000123", "-0.00000123" },
        // No exp format up to 1e-6:
        { "-0.00001234567890123456", "-0.00001234567890123456" },
        { "-0.000001234567890123456", "-0.000001234567890123456" },
        { "0.00001234567890123456", "0.00001234567890123456" },
        { "0.000001234567890123456", "0.000001234567890123456" },
        { "0.0000001234567890123456", "1.234567890123456e-7" },
        { "+42", "42" },
        { "0.0000000000000001", "1e-16" },
        { "9999999999999999", "9999999999999999" },
        { "-9999999999999999", "-9999999999999999" },
        { "1", "1" },
        { "1.227", "1.227" },
        { "0", "0" },
        { "-0", "0" },
        { "99999999.999999994", "99999999.999999994" },
        { "99999999.999999995", "99999999.999999995" },
        { "1.23456789012345678901234567890123456789", "1.234567890123456789012345678901235" },
    };

    int passed = 0;
    int total = sizeof(tests) / sizeof(tests[0]);

    printf("dec128: Testing string conversions\n");

    for (int i = 0; i < total; ++i) {
        dec128_set_str(&x, tests[i].input);
        dec128_get_str(&x, buf, sizeof(buf));

        if (strcmp(buf, tests[i].expected) == 0) {
            printf("Test %d passed: '%s=%s'\n", i + 1, tests[i].input, buf);
            passed++;
        } else {
            printf("Test %d failed: input='%s' expected='%s' got='%s' (0x%lx %lx)\n",
                   i + 1, tests[i].input, tests[i].expected, buf, (uint64_t)(x.bits>>64),
                   (uint64_t)(x.bits % ((__uint128_t)1ULL<<64)));
        }
    }

    printf("\n%d/%d tests passed.\n", passed, total);
    return (passed == total) ? 0 : 1;
}

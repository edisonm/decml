:- module(lanczos,
          [ lanczos/3,
            gammap1/4,
            gamma/4,
            lgammap1/4,
            lgamma/4
          ]).

:- use_module(library(clpcd)).
:- use_module(library(cdfloatn)).

/* Calculates the lanczos coefficients, just interpolating, since the integrals
 * where too complicated, it turns out that it is way easier if we stablish a
 * systems of equations to interpolate the coefficients.

Example, calculate the coefficients given as example in the Wikipedia:

?- [library(lanczos)].
true.

?- lanczos(7,9,G),maplist(writeln,G),fail.
0.9999999999998099322768470047347829718009602570498980962898849358333528645174422
676.5203681218850985670091904440190381974449058924722569853678706942114159237788
-1259.139216722402870471560787552828410476730722910298369550296701330512395056881
771.3234287776530788486528258894307395627292390168566479072763665555536041012736
-176.6150291621405990658455135399941244433015398373585840448427972143014070777221
12.50734327868690481445893685327163629939919667813089937179501691964045582522465
-0.1385710952657201168955470698506320982416866194189568573645197562927150473257001
9.984369578019570859562668995694018788834042365371027657733869657771779362028925e-6
1.505632735149311558338355775386439360927036032480858107693789119703648273137641e-7
false.

% increase the precision to get the values right
?- set_clpcd(cdfloatn(256)).
Correct to: "clpcd_domain_ops:set_clpcd(cdfloatn(256))"? y
true.

?- lanczos(8,12,G),maplist(writeln,G),fail.
0.9999999999999999298072683210053961619688770239641926303795788539010937350319957
1975.373902357885232196174864365176079539383378363225740060181013674440667029569
-4397.382392792242891788490670338461736544385545443367527175081636787712747854004
3462.632845986271701871134312531791526450793628226544938824235169346743577848947
-1156.98514316311678201041293672611019752419147288780316174540160867359349417733
154.5381505025277505979122255678930447816794838287526256667679591767023813683263
-6.253671612368916179801922885743158398781916571592190758988595428168128137260809
0.03464276245473680744080144427829370710333040666527154165161320123990726735633223
-7.477617197444297737731906535423340153812588431554899464012611120100840701575718e-7
6.304125382185226426062787298031392437482837747552479179029870335902660163292845e-8
-2.740571703568387748866160197011298704406419738328063206978375488290971879157721e-8
4.048694881756760910065772516149371619328969239626119963430092728508684064346333e-9
false.

% Not in Wikipedia, but used in dec128:
?- set_clpcd(cdfloatn(512)).
Correct to: "clpcd_domain_ops:set_clpcd(cdfloatn(512))"? y
true.

?- lanczos(18,25,G),maplist(writeln,G),fail.
0.99999999999999999999999999999999950239649801894207360442888428664168804982529130467888866394773257188017994432347692886712024987217975268236252456924474982
66463395.2868319779240999090811958609252406467155492249362845470378600725137049350044681966226604076545196192388839228059017405053732458979778683354719629054
-391737307.096146436261318902857994423824042945224728670815404072743377723919291333852152966243193548960591361195705503087004747199211477223258783579464799002
1016889551.69804578250724792561192594617656615248430803835231254280298425649739571171422494464665182123490320086882625020280563236256872326969713593736487787
-1530441772.02666047419497722137586126913902138418485201741766353330841904592429788218669819137847530659949188265725370823840938734953670016328811579756844716
1479708907.04299751494401059374328143383480597174271615012814971526601512970251228555010459825359217889729485557373342427897855888483163350133975234093910632
-962531419.960957313410598994920943577309398898958697983502281698469033073471180790807468841794845494329959788599016397267546507495825847329570743380404072935
429042261.924625894327014073301819521487170612838535055940444837390982291597805862986234222933187098253311562721740747768627202206999997635165994165493231047
-131066388.397594568671022946165497922606530873726813699678201324171163591732542687818820271259055621346890775910882268771213711919493141175922581538530321546
27029484.6496531399668256183174208533341272759620019186767468883631252519423947251905290771474904431656980774211334963480922129583790123258694047933469132074
-3648630.82931225297009604906256803161778998142196102846211415866635138475214348109844519299624167926593876619373816187328416276674845941572843732742214755892
306548.300559797102811424108080257549701865918339464595257722892080608487545581219395552153923308305442243105596798593131632848348304890786455145363355737921
-14831.0562325517336557602761533938222690863823827688627099174943568900244414756999130357209727830630283752122567670562963084177966420317428730234840117268914
366.206771786630697789514024535695347334332427842724753266452483057747623632355386635135637764443218018125257729131791415558730629966515875215856129855978857
-3.79597946143285486342541197070296187200357751455564825423389420473348136450222286816939762044195439300364970099463788278072934323300982994880875096945395916
0.0117359714273464590046348057509891376130809573835812807094821628079737503266559406255968071514381379898974563001413659935088549601146978077559193213283626559
-5.47289094142757683588727086692843795112132876116443406166482550751590403798621804866781416386552903586718034985382104322251321949976498137069686243858487379e-6
6.87473096368100258629456919899468879272574903881763025055916079057174289452972784186801380318482346143283946831775269386593947201655704616926070371832384533e-11
-3.15016984153346689553044641282066720947417932123593552709495897772218915929572649645244717468798387388104873598529356728097716133435865226984911732112011494e-15
2.35484699510061124582194793554404248370378487182640838215587509140198443700101323984505460939397539947328905125491165874457041471602495653907431729638228409e-15
-1.03412267749911693785586759018751395748586137465245235246110929622713761591282355577515887466671489313820871987654382330959159997442727170347275926709440059e-15
2.58646039896997064498829735441968957295481873463434805295433508019687983461289661508454660984794015456864475620720614765074033616908659607620332278360250759e-16
-3.36594222301306676310757549459522646659866218356082339406849811437699885262239221699384657983993348353171936982278672182379515590439399427508353400130190368e-17
9.29812933442872193652511917862363010980952882183104571879869763165424452607201221379403901621697834733101726464483714944162120928213387127120975345013755855e-19
2.04499900672945356180700421238714690512351069383081502785816992454280063155234822203264802743353393817088273379119458799187501586352174489461799745183480554e-19
false.

*/

/*
b(G, Z, B) :-
    lb(G, Z, LB),
    {B = exp(LB)}.
*/

b(G, Z, B) :-
    { T = (Z+G+1/2),
      Sqrt2Pi = sqrt(8*atan(1)),
      B = Sqrt2Pi*T**(Z+1/2)/exp(T)
    }.

lb(G, Z, B) :-
    { T = (Z+G+1/2),
      LSqrt2Pi = log(2*pi)/2,
      B = LSqrt2Pi+log(T)*(Z+1/2)-T
    }.

gammap1(G, N, Z, S) :-
    lanczos(G, N, P),
    lanczos_agz(P, Z, A),
    b(G, Z, B),
    {S = B*A}.

gamma(G, N, Z, S) :- gammap1(G, N, Z-1, S).
    

lgammap1(G, N, Z, S) :-
    lanczos(G, N, P),
    lanczos_agz(P, Z, A),
    lb(G, Z, B),
    {S = B+log(A)}.

lgamma(G, N, Z, S) :- lgammap1(G, N, N-1, S).

fact(0, 1) :- !.
fact(N, F) :-
    N > 0,
    succ(N1, N),
    fact(N1, F1),
    {F = N * F1}.

lanczos(G, N, P) :-
    length(P, N),
    succ(N1, N),
    findall(X, between(0, N1, X), L),
    maplist(lanczos_eq(G, P), L).

lanczos_agz([C0|P], Z, S) :-
    {Z1 = Z + 1},
    lanczos_agz(P, Z1, C0, S).

lanczos_agz([],      _,   S, S).
lanczos_agz([Pk|P], ZK1, S1, S) :-
    { ZK = ZK1 + 1,
      S2 = S1 + Pk/(ZK1)
    },
    lanczos_agz(P, ZK, S2, S).

lanczos_eq(G, P, K) :-
    fact(K, FactZ),
    b(G, K, B),
    {S = FactZ/B},
    lanczos_agz(P, K, S).
